{% extends "base.html" %}

{% block page_title %}API Calls{% endblock %}

{% block content %}
<div class="api-calls-container">
    <div class="api-calls-header">
        <h2>Last 100 API Calls</h2>
        <button id="refreshBtn" class="btn-refresh" onclick="refreshEvents()">ðŸ”„ Refresh</button>
        <span id="lastRefresh" class="last-refresh">Loading...</span>
    </div>

    <div id="eventsContainer" class="events-list">
        <p class="loading">Loading API calls...</p>
    </div>
</div>

<style>
.api-calls-container {
    padding: 0;
}

.api-calls-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    flex-wrap: wrap;
    gap: 1rem;
}

.api-calls-header h2 {
    margin: 0;
    flex: 1;
}

.btn-refresh {
    background: #3498db;
    color: white;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 4px;
    cursor: pointer;
    font-size: 1rem;
    transition: background 0.2s;
}

.btn-refresh:hover {
    background: #2980b9;
}

.btn-refresh:active {
    transform: scale(0.98);
}

.last-refresh {
    color: #666;
    font-size: 0.9rem;
}

.events-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.event-card {
    background: white;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 1rem;
    transition: box-shadow 0.2s;
}

.event-card:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.event-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 0.75rem;
    flex-wrap: wrap;
}

.event-method {
    display: inline-block;
    padding: 0.4rem 0.8rem;
    border-radius: 4px;
    color: white;
    font-weight: bold;
    font-size: 0.85rem;
    min-width: 60px;
    text-align: center;
}

.event-method.get {
    background: #61affe;
}

.event-method.post {
    background: #49cc90;
}

.event-method.put {
    background: #fca130;
}

.event-method.delete {
    background: #f93e3e;
}

.event-method.patch {
    background: #50e3c2;
}

.event-route {
    font-family: 'Monaco', 'Courier New', monospace;
    color: #333;
    flex: 1;
    min-width: 200px;
    word-break: break-all;
}

.event-status {
    padding: 0.4rem 0.8rem;
    border-radius: 4px;
    color: white;
    font-weight: bold;
    font-size: 0.85rem;
}

.event-status.success {
    background: #49cc90;
}

.event-status.error {
    background: #f93e3e;
}

.event-status.warning {
    background: #fca130;
}

.event-time {
    color: #999;
    font-size: 0.85rem;
    white-space: nowrap;
}

.event-details {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    margin-top: 0.75rem;
}

.event-section {
    background: #f8f8f8;
    padding: 0.75rem;
    border-radius: 4px;
    overflow-x: auto;
}

.event-section-title {
    font-weight: bold;
    color: #333;
    margin-bottom: 0.5rem;
    font-size: 0.85rem;
}

.event-section code {
    font-family: 'Monaco', 'Courier New', monospace;
    font-size: 0.75rem;
    color: #333;
    word-break: break-all;
}

.event-section pre {
    margin: 0;
    white-space: pre-wrap;
}

.empty-state {
    text-align: center;
    padding: 3rem 1rem;
    color: #999;
}

.empty-state p {
    font-size: 1.1rem;
    margin-bottom: 0.5rem;
}

.loading {
    text-align: center;
    padding: 2rem;
    color: #999;
}

.refresh-indicator {
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #49cc90;
    margin-right: 0.5rem;
    animation: pulse 1s infinite;
}

@keyframes pulse {
    0%, 100% {
        opacity: 1;
    }
    50% {
        opacity: 0.5;
    }
}

@media (max-width: 768px) {
    .event-details {
        grid-template-columns: 1fr;
    }

    .api-calls-header {
        flex-direction: column;
        align-items: stretch;
    }

    .api-calls-header h2 {
        flex: none;
    }

    .btn-refresh {
        flex: 1;
    }

    .event-header {
        flex-direction: column;
        align-items: flex-start;
    }
}
</style>

<script>
let autoRefreshInterval = null;

async function loadEvents() {
    const container = document.getElementById('eventsContainer');
    const lastRefreshEl = document.getElementById('lastRefresh');

    try {
        const response = await fetch('http://localhost:{{ api_port }}/events');
        const data = await response.json();

        if (!data.success || !data.events || data.events.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <p>No API calls yet</p>
                    <p style="font-size: 0.9rem;">API calls will appear here as they are made</p>
                </div>
            `;
            lastRefreshEl.textContent = 'Last refresh: ' + new Date().toLocaleTimeString();
            return;
        }

        container.innerHTML = '';

        data.events.forEach((event, index) => {
            const timestamp = new Date(event.timestamp);
            const isError = !event.success;
            const statusClass = isError ? 'error' : 'success';

            const eventCard = document.createElement('div');
            eventCard.className = 'event-card';
            eventCard.innerHTML = `
                <div class="event-header">
                    <span class="event-method ${event.method.toLowerCase()}">${event.method}</span>
                    <span class="event-route">${event.route}</span>
                    <span class="event-status ${statusClass}">${event.status}</span>
                    <span class="event-time">${timestamp.toLocaleString()}</span>
                </div>

                <div class="event-details">
                    <div class="event-section">
                        <div class="event-section-title">Request</div>
                        <pre><code>${JSON.stringify(event.input, null, 2)}</code></pre>
                    </div>
                    <div class="event-section">
                        <div class="event-section-title">Response</div>
                        <pre><code>${JSON.stringify(event.output, null, 2)}</code></pre>
                    </div>
                </div>
            `;

            container.appendChild(eventCard);
        });

        lastRefreshEl.innerHTML = `<span class="refresh-indicator"></span>Last refresh: ${new Date().toLocaleTimeString()}`;
        console.log(`Loaded ${data.events.length} events`);

    } catch (error) {
        console.error('Error loading events:', error);
        container.innerHTML = `
            <div class="empty-state">
                <p>Error loading events</p>
                <p style="font-size: 0.9rem; color: #f93e3e;">${error.message}</p>
            </div>
        `;
        lastRefreshEl.textContent = 'Error loading events';
    }
}

function refreshEvents() {
    const btn = document.getElementById('refreshBtn');
    btn.disabled = true;
    btn.style.opacity = '0.6';

    loadEvents().finally(() => {
        btn.disabled = false;
        btn.style.opacity = '1';
    });
}

// Load events on page load
document.addEventListener('DOMContentLoaded', () => {
    loadEvents();

    // Auto-refresh every 5 seconds
    autoRefreshInterval = setInterval(loadEvents, 5000);

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
        if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
        }
    });
});
</script>
{% endblock %}

{% extends "base.html" %}

{% block page_title %}API Calls{% endblock %}

{% block content %}
<div class="api-calls-container">
    <div class="api-calls-header">
        <h2>Last 100 API Calls</h2>
        <button id="refreshBtn" class="btn-refresh" onclick="refreshEvents()">ðŸ”„ Refresh</button>
        <span id="lastRefresh" class="last-refresh">Loading...</span>
    </div>

    <div id="eventsContainer" class="events-list">
        <p class="loading">Loading API calls...</p>
    </div>
</div>



<script>
let autoRefreshInterval = null;

async function loadEvents() {
    const container = document.getElementById('eventsContainer');
    const lastRefreshEl = document.getElementById('lastRefresh');

    try {
        const response = await fetch('http://localhost:{{ api_port }}/events');
        const data = await response.json();

        if (!data.success || !data.events || data.events.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <p>No API calls yet</p>
                    <p style="font-size: 0.9rem;">API calls will appear here as they are made</p>
                </div>
            `;
            lastRefreshEl.textContent = 'Last refresh: ' + new Date().toLocaleTimeString();
            return;
        }

        container.innerHTML = '';

        data.events.forEach((event, index) => {
            const timestamp = new Date(event.timestamp);
            const isError = !event.success;
            const statusClass = isError ? 'error' : 'success';

            const eventCard = document.createElement('div');
            eventCard.className = 'event-card';
            eventCard.innerHTML = `
                <div class="event-header">
                    <span class="event-method ${event.method.toLowerCase()}">${event.method}</span>
                    <span class="event-route">${event.route}</span>
                    <span class="event-status ${statusClass}">${event.status}</span>
                    <span class="event-time">${timestamp.toLocaleString()}</span>
                </div>

                <div class="event-details">
                    <div class="event-section">
                        <div class="event-section-title">Request</div>
                        <pre><code>${JSON.stringify(event.input, null, 2)}</code></pre>
                    </div>
                    <div class="event-section">
                        <div class="event-section-title">Response</div>
                        <pre><code>${JSON.stringify(event.output, null, 2)}</code></pre>
                    </div>
                </div>
            `;

            container.appendChild(eventCard);
        });

        lastRefreshEl.innerHTML = `<span class="refresh-indicator"></span>Last refresh: ${new Date().toLocaleTimeString()}`;
        console.log(`Loaded ${data.events.length} events`);

    } catch (error) {
        console.error('Error loading events:', error);
        container.innerHTML = `
            <div class="empty-state">
                <p>Error loading events</p>
                <p style="font-size: 0.9rem; color: #f93e3e;">${error.message}</p>
            </div>
        `;
        lastRefreshEl.textContent = 'Error loading events';
    }
}

function refreshEvents() {
    const btn = document.getElementById('refreshBtn');
    btn.disabled = true;
    btn.style.opacity = '0.6';

    loadEvents().finally(() => {
        btn.disabled = false;
        btn.style.opacity = '1';
    });
}

// Load events on page load
document.addEventListener('DOMContentLoaded', () => {
    loadEvents();

    // Auto-refresh every 5 seconds
    autoRefreshInterval = setInterval(loadEvents, 5000);

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
        if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
        }
    });
});
</script>
{% endblock %}

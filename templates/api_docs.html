{% extends "base.html" %}

{% block page_title %}API Documentation{% endblock %}

{% block content %}
<div class="api-docs-main">
    <div class="docs-header">
        <h2>API Documentation</h2>
        <button id="fetchDocsBtn" class="btn-fetch" onclick="fetchDocumentation()">ðŸ“¥ Fetch Documentation</button>
        <span id="docsStatus" class="status-text">Click button to load documentation</span>
    </div>

    <div class="api-info">
        <span class="api-base-url">Base URL: http://localhost:8001</span>
        <span class="api-version">Version: 1.0.0</span>
    </div>

    <div class="docs-container">
        <div class="docs-panel">
            <div id="docsContainer" class="docs-list">
                <p class="placeholder">Click "Fetch Documentation" button to load routes</p>
            </div>
        </div>

        <div class="source-panel">
            <div class="source-header">
                <h3>FastAPI Server Source</h3>
                <button id="refreshSourceBtn" class="btn-source-refresh" onclick="refreshSourceCode()">ðŸ”„ Refresh</button>
            </div>
            <div id="sourceContainer" class="source-code">
                <p class="placeholder">Source code will appear here</p>
            </div>
        </div>
    </div>
</div>

<style>
.api-docs-main {
    padding: 0;
}

.docs-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    flex-wrap: wrap;
    gap: 1rem;
}

.docs-header h2 {
    margin: 0;
    flex: 1;
}

.btn-fetch {
    background: #49cc90;
    color: white;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 4px;
    cursor: pointer;
    font-size: 1rem;
    transition: background 0.2s;
    white-space: nowrap;
}

.btn-fetch:hover {
    background: #27ae60;
}

.btn-fetch:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

.status-text {
    color: #666;
    font-size: 0.9rem;
    white-space: nowrap;
}

.api-info {
    display: flex;
    gap: 2rem;
    flex-wrap: wrap;
    margin-bottom: 1.5rem;
}

.api-base-url, .api-version {
    font-family: 'Monaco', 'Courier New', monospace;
    background: #f5f5f5;
    padding: 0.5rem 1rem;
    border-radius: 4px;
    font-size: 0.9rem;
}

.docs-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
}

.docs-panel, .source-panel {
    background: white;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 1.5rem;
    max-height: 70vh;
    overflow-y: auto;
}

.source-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.source-header h3 {
    margin: 0;
}

.btn-source-refresh {
    background: #3498db;
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9rem;
    transition: background 0.2s;
}

.btn-source-refresh:hover {
    background: #2980b9;
}

.btn-source-refresh:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

.docs-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.route-card {
    background: #f8f8f8;
    border: 1px solid #ddd;
    border-radius: 6px;
    padding: 1rem;
    transition: box-shadow 0.2s;
}

.route-card:hover {
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
}

.route-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 0.75rem;
    flex-wrap: wrap;
}

.route-method {
    display: inline-block;
    padding: 0.3rem 0.6rem;
    border-radius: 3px;
    color: white;
    font-weight: bold;
    font-size: 0.8rem;
    min-width: 50px;
    text-align: center;
}

.route-method.get { background: #61affe; }
.route-method.post { background: #49cc90; }
.route-method.put { background: #fca130; }
.route-method.delete { background: #f93e3e; }

.route-path {
    font-family: 'Monaco', 'Courier New', monospace;
    color: #333;
    font-size: 0.9rem;
    background: white;
    padding: 0.3rem 0.5rem;
    border-radius: 3px;
}

.route-info {
    font-size: 0.85rem;
    color: #666;
    margin-top: 0.5rem;
}

.route-info strong {
    color: #333;
}

.source-code {
    padding: 1rem;
    border-radius: 4px;
    overflow: auto;
}

.source-code pre {
    margin: 0;
    white-space: pre;
    word-wrap: break-word;
    font-family: 'Monaco', 'Courier New', monospace;
    font-size: 0.8rem;
}

.source-code code {
    padding: 0;
}

.placeholder {
    text-align: center;
    padding: 2rem 1rem;
    color: #999;
    font-style: italic;
}

.error-message {
    background: #f8d7da;
    color: #721c24;
    padding: 1rem;
    border-radius: 4px;
    border: 1px solid #f5c6cb;
}

.loading {
    text-align: center;
    padding: 1rem;
    color: #999;
}

@media (max-width: 1024px) {
    .docs-container {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 768px) {
    .docs-header {
        flex-direction: column;
        align-items: stretch;
    }

    .btn-fetch {
        flex: 1;
    }

    .route-header {
        flex-direction: column;
        align-items: flex-start;
    }
}
</style>

<script>
async function fetchDocumentation() {
    const container = document.getElementById('docsContainer');
    const statusEl = document.getElementById('docsStatus');
    const btn = document.getElementById('fetchDocsBtn');

    btn.disabled = true;
    statusEl.textContent = 'Fetching documentation...';
    container.innerHTML = '<p class="loading">Loading...</p>';

    try {
        const response = await fetch('http://localhost:8001/api/documentation');

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const data = await response.json();

        if (!data.success || !data.routes) {
            throw new Error('Invalid documentation format');
        }

        container.innerHTML = '';
        let count = 0;

        Object.entries(data.routes).forEach(([routeName, route]) => {
            count++;
            const routeCard = document.createElement('div');
            routeCard.className = 'route-card';

            routeCard.innerHTML = `
                <div class="route-header">
                    <span class="route-method ${route.method.toLowerCase()}">${route.method}</span>
                    <span class="route-path">${route.route}</span>
                </div>
                <div class="route-info">
                    <div><strong>Function:</strong> ${route.function}</div>
                    <div><strong>Description:</strong> ${route.description}</div>
                    ${route.file ? `<div><strong>File:</strong> ${route.file}</div>` : ''}
                    <div><strong>Example:</strong> <code>${route.example_curl}</code></div>
                </div>
            `;

            container.appendChild(routeCard);
        });

        statusEl.textContent = `âœ“ Loaded ${count} routes`;

    } catch (error) {
        console.error('Error:', error);
        container.innerHTML = `
            <div class="error-message">
                <strong>Error loading documentation:</strong><br>
                ${error.message}<br><br>
                <small>Make sure the FastAPI server is running on port 8001</small>
            </div>
        `;
        statusEl.textContent = 'âœ— Failed to load';
    } finally {
        btn.disabled = false;
    }
}

async function refreshSourceCode() {
    const container = document.getElementById('sourceContainer');
    const btn = document.getElementById('refreshSourceBtn');

    btn.disabled = true;
    container.innerHTML = '<p class="loading">Loading source code...</p>';

    try {
        const response = await fetch('/ui/api/fastapi-source');

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }

        const data = await response.json();

        if (data.success) {
            container.innerHTML = `<pre><code class="language-python">${escapeHtml(data.source)}</code></pre>`;
            hljs.highlightAll();
        } else {
            throw new Error(data.error || 'Unknown error');
        }

    } catch (error) {
        container.innerHTML = `
            <div class="error-message">
                <strong>Error loading source:</strong><br>
                ${error.message}
            </div>
        `;
    } finally {
        btn.disabled = false;
    }
}

function escapeHtml(text) {
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, m => map[m]);
}

// Load source code on page load
document.addEventListener('DOMContentLoaded', refreshSourceCode);
</script>
{% endblock %}

{% extends "base.html" %}

{% block page_title %}API Documentation{% endblock %}

{% block content %}
<div class="api-docs-main">
    <div class="docs-header">
        <h2>API Documentation</h2>
        <button id="fetchDocsBtn" class="btn-fetch" onclick="fetchDocumentation()">ðŸ“¥ Fetch Documentation</button>
        <span id="docsStatus" class="status-text">Click button to load documentation</span>
    </div>

    <div class="api-info">
        <span class="api-base-url">Base URL: http://localhost:{{ config.run_details.root_port + config.run_details.port_offsets.api }}</span>
        <span class="api-version">Version: 1.0.0</span>
    </div>

    <div class="docs-container">
        <div class="docs-panel">
            <div id="docsContainer" class="docs-list">
                <p class="placeholder">Click "Fetch Documentation" button to load routes</p>
            </div>
        </div>

        <div class="source-panel">
            <div class="source-header">
                <h3>FastAPI Server Source</h3>
                <button id="refreshSourceBtn" class="btn-source-refresh" onclick="refreshSourceCode()">ðŸ”„ Refresh</button>
            </div>
            <div id="sourceContainer" class="source-code">
                <p class="placeholder">Source code will appear here</p>
            </div>
        </div>
    </div>
</div>



<script>
const API_PORT = {{ config.run_details.root_port + config.run_details.port_offsets.api }};
const API_BASE_URL = `http://localhost:${API_PORT}`;

async function fetchDocumentation() {
    const container = document.getElementById('docsContainer');
    const statusEl = document.getElementById('docsStatus');
    const btn = document.getElementById('fetchDocsBtn');

    btn.disabled = true;
    statusEl.textContent = 'Fetching documentation...';
    container.innerHTML = '<p class="loading">Loading...</p>';

    try {
        const response = await fetch(`${API_BASE_URL}/api/documentation`);

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const data = await response.json();

        if (!data.success || !data.routes) {
            throw new Error('Invalid documentation format');
        }

        container.innerHTML = '';
        let count = 0;

        Object.entries(data.routes).forEach(([routeName, route]) => {
            count++;
            const routeCard = document.createElement('div');
            routeCard.className = 'route-card';

            routeCard.innerHTML = `
                <div class="route-header">
                    <span class="route-method ${route.method.toLowerCase()}">${route.method}</span>
                    <span class="route-path">${route.route}</span>
                </div>
                <div class="route-info">
                    <div><strong>Function:</strong> ${route.function}</div>
                    <div><strong>Description:</strong> ${route.description}</div>
                    ${route.file ? `<div><strong>File:</strong> ${route.file}</div>` : ''}
                    <div><strong>Example:</strong> <code>${route.example_curl}</code></div>
                </div>
            `;

            container.appendChild(routeCard);
        });

        statusEl.textContent = `âœ“ Loaded ${count} routes`;

    } catch (error) {
        console.error('Error:', error);
        container.innerHTML = `
            <div class="error-message">
                <strong>Error loading documentation:</strong><br>
                ${error.message}<br><br>
                <small>Make sure the FastAPI server is running on port ${API_PORT}</small>
            </div>
        `;
        statusEl.textContent = 'âœ— Failed to load';
    } finally {
        btn.disabled = false;
    }
}

async function refreshSourceCode() {
    const container = document.getElementById('sourceContainer');
    const btn = document.getElementById('refreshSourceBtn');

    btn.disabled = true;
    container.innerHTML = '<p class="loading">Loading source code...</p>';

    try {
        const response = await fetch('/ui/api/fastapi-source');

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }

        const data = await response.json();

        if (data.success) {
            container.innerHTML = `<pre><code class="language-python">${escapeHtml(data.source)}</code></pre>`;
            hljs.highlightAll();
        } else {
            throw new Error(data.error || 'Unknown error');
        }

    } catch (error) {
        container.innerHTML = `
            <div class="error-message">
                <strong>Error loading source:</strong><br>
                ${error.message}
            </div>
        `;
    } finally {
        btn.disabled = false;
    }
}

// Load source code on page load
document.addEventListener('DOMContentLoaded', refreshSourceCode);
</script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

{% endblock %}
